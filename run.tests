#!/bin/bash
# run.tests - Check that the algorithm does what it is supposed to

if test -z "$srcdir"; then
  srcdir=.
  test "${VERBOSE+set}" != "set" && VERBOSE=yes
fi

# See how redirections should work.
if test -z "$VERBOSE"; then
   exec > /dev/null 2>&1
fi

path=`dirname $0`

if ! test -f "./fribidi"; then
  echo "run.tests: you must make fribidi first"
  exit 1
fi

TEST () {
  testcase="$1"
  test="${testcase##*/}"
  test="${test%.input}"
  charset="${testcase#*_}"
  charset="${charset%%_*}"
  echo -n "=== $test === "
  if ! ./fribidi --charset "$charset" </dev/null >/dev/null 2>&1; then
    echo " [Character set not supported]"
    return 0
  fi
  ./fribidi --test --charset "$charset" "$testcase" > "$test.output"

  reference="${testcase%.input}.reference";
  test -f "$reference" || reference="tests/${reference##*/}"
  if diff "$test.output" "$reference"; then
    rm "$test.output"
    echo " [Passed]"
    return 0
  else
    echo " [Failed]"
    return 1
  fi
}

retval=0
for testcase in "$path/tests/"test_*.input; do
  TEST "$testcase" || retval=1
done

exit $retval
